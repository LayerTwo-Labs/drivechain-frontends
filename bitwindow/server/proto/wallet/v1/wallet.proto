syntax = "proto3";

package wallet.v1;

import "bitwindowd/v1/bitwindowd.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

service WalletService {
  rpc SendTransaction(SendTransactionRequest) returns (SendTransactionResponse);
  rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse);
  // Problem: deriving nilly willy here is potentially problematic. There's no way of listing
  // out unused addresses, so we risk crossing the sync gap.
  rpc GetNewAddress(GetNewAddressRequest) returns (GetNewAddressResponse);
  rpc ListTransactions(ListTransactionsRequest) returns (ListTransactionsResponse);
  rpc ListUnspent(ListUnspentRequest) returns (ListUnspentResponse);
  rpc ListReceiveAddresses(ListReceiveAddressesRequest) returns (ListReceiveAddressesResponse);

  rpc ListSidechainDeposits(ListSidechainDepositsRequest) returns (ListSidechainDepositsResponse);
  rpc CreateSidechainDeposit(CreateSidechainDepositRequest) returns (CreateSidechainDepositResponse);

  rpc SignMessage(SignMessageRequest) returns (SignMessageResponse);
  rpc VerifyMessage(VerifyMessageRequest) returns (VerifyMessageResponse);

  rpc GetStats(GetStatsRequest) returns (GetStatsResponse);

  // Wallet unlock/lock for cheque operations
  rpc UnlockWallet(UnlockWalletRequest) returns (google.protobuf.Empty);
  rpc LockWallet(google.protobuf.Empty) returns (google.protobuf.Empty);
  rpc IsWalletUnlocked(google.protobuf.Empty) returns (google.protobuf.Empty);

  // Cheque operations
  rpc CreateCheque(CreateChequeRequest) returns (CreateChequeResponse);
  rpc GetCheque(GetChequeRequest) returns (GetChequeResponse);
  rpc GetChequePrivateKey(GetChequePrivateKeyRequest) returns (GetChequePrivateKeyResponse);
  rpc ListCheques(ListChequesRequest) returns (ListChequesResponse);
  rpc CheckChequeFunding(CheckChequeFundingRequest) returns (CheckChequeFundingResponse);
  rpc SweepCheque(SweepChequeRequest) returns (SweepChequeResponse);
  rpc DeleteCheque(DeleteChequeRequest) returns (google.protobuf.Empty);
}

message GetBalanceRequest {
  string wallet_id = 1;
}

message GetNewAddressRequest {
  string wallet_id = 1;
}

message GetNewAddressResponse {
  string address = 1;
  uint32 index = 2;
}

message ListTransactionsRequest {
  string wallet_id = 1;
}

message ListUnspentRequest {
  string wallet_id = 1;
}

message ListReceiveAddressesRequest {
  string wallet_id = 1;
}

message GetStatsRequest {
  string wallet_id = 1;
}

message SendTransactionRequest {
  string wallet_id = 1;

  // Map of destination address to amount in satoshi.
  map<string, uint64> destinations = 2;

  // Fee rate, measured in sat/vb. If set to zero, a reasonable
  // rate is used by asking Core for an estimate.
  uint64 fee_sat_per_vbyte = 3;

  // Hard-coded amount, in sats.
  uint64 fixed_fee_sats = 4;

  // Message to include as an OP_RETURN output
  string op_return_message = 5;

  // If set, will save the address with this label in the address book
  string label = 6;

  // UTXOs that must be included in the transaction.
  repeated UnspentOutput required_inputs = 7;
}

message SendTransactionResponse {
  string txid = 1;
}

message GetBalanceResponse {
  uint64 confirmed_satoshi = 1;

  uint64 pending_satoshi = 2;
}

message ListTransactionsResponse {
  repeated WalletTransaction transactions = 1;
}

message UnspentOutput {
  // The vout:index of the utxo
  string output = 1;
  // What address the utxo was received to.
  string address = 2;
  // What label (if any) the address received to is labeled with.
  string label = 3;
  // The value of the output, in satoshis.
  uint64 value_sats = 4;
  // Whether this is a change output.
  bool is_change = 5;
  // Timestamp of the utxo.
  google.protobuf.Timestamp received_at = 6;
  // If set, this utxo is part of a denial chain
  optional bitwindowd.v1.DenialInfo denial_info = 7;
}

message ListUnspentResponse {
  repeated UnspentOutput utxos = 1;
}

message ListReceiveAddressesResponse {
  repeated ReceiveAddress addresses = 1;
}

message ReceiveAddress {
  string address = 1;
  string label = 2;
  uint64 current_balance_sat = 3;
  bool is_change = 4;
  google.protobuf.Timestamp last_used_at = 5;
}

message Confirmation {
  uint32 height = 1;
  google.protobuf.Timestamp timestamp = 2;
}

message WalletTransaction {
  string txid = 1;

  uint64 fee_sats = 2;
  uint64 received_satoshi = 3;
  uint64 sent_satoshi = 4;
  string address = 5;
  string address_label = 6;
  string note = 7;

  Confirmation confirmation_time = 8;
}

message ListSidechainDepositsRequest {
  string wallet_id = 1;
  int32 slot = 2;
}

message ListSidechainDepositsResponse {
  message SidechainDeposit {
    string txid = 1;
    int64 amount = 2;
    int64 fee = 3;
    int32 confirmations = 4;
  }

  repeated SidechainDeposit deposits = 1;
}

message CreateSidechainDepositRequest {
  string wallet_id = 1;
  // The sidechain deposit address to send to.
  int64 slot = 2;
  // The sidechain deposit address to send to.
  string destination = 3;
  // The amount in BTC to send. eg 0.1
  double amount = 4;
  // The fee in BTC
  double fee = 5;
}

message CreateSidechainDepositResponse {
  string txid = 1;
}

message SignMessageRequest {
  string wallet_id = 1;
  string message = 2;
}
message SignMessageResponse {
  string signature = 1;
}

message VerifyMessageRequest {
  string wallet_id = 1;
  string message = 2;
  string signature = 3;
  string public_key = 4;
}
message VerifyMessageResponse {
  bool valid = 1;
}

message GetStatsResponse {
  uint64 utxos_current = 1;
  uint64 utxos_unique_addresses = 2;
  int64 sidechain_deposit_volume = 3;
  int64 sidechain_deposit_volume_last_30_days = 4;
  int64 transaction_count_total = 5;
  int64 transaction_count_since_month = 6;
}

// Wallet unlock/lock messages
message UnlockWalletRequest {
  string password = 1;
}

// Cheque messages
message CreateChequeRequest {
  string wallet_id = 1;
  uint64 expected_amount_sats = 2;
}

message CreateChequeResponse {
  int64 id = 1;
  string address = 2;
  uint32 derivation_index = 3;
}

message GetChequeRequest {
  string wallet_id = 1;
  int64 id = 2;
}

message GetChequeResponse {
  Cheque cheque = 1;
}

message GetChequePrivateKeyRequest {
  string wallet_id = 1;
  int64 id = 2;
}

message GetChequePrivateKeyResponse {
  string private_key_wif = 1;
}

message Cheque {
  int64 id = 1;
  uint32 derivation_index = 2;
  string address = 3;
  uint64 expected_amount_sats = 4;
  bool funded = 5;
  optional string funded_txid = 6;
  optional uint64 actual_amount_sats = 7;
  google.protobuf.Timestamp created_at = 8;
  optional google.protobuf.Timestamp funded_at = 9;
  optional string private_key_wif = 10;
  optional string swept_txid = 11;
  optional google.protobuf.Timestamp swept_at = 12;
}

message ListChequesRequest {
  string wallet_id = 1;
}

message ListChequesResponse {
  repeated Cheque cheques = 1;
}

message CheckChequeFundingRequest {
  string wallet_id = 1;
  int64 id = 2;
}

message CheckChequeFundingResponse {
  bool funded = 1;
  uint64 actual_amount_sats = 2;
  string funded_txid = 3;
  optional google.protobuf.Timestamp funded_at = 4;
}

message SweepChequeRequest {
  string wallet_id = 1;
  string private_key_wif = 2;
  string destination_address = 3;
  uint64 fee_sat_per_vbyte = 4;
}

message SweepChequeResponse {
  string txid = 1;
  uint64 amount_sats = 2;
}

message DeleteChequeRequest {
  string wallet_id = 1;
  int64 id = 2;
}
